# API Gateway Configuration

service:
  name: api-gateway
  version: 1.0.0
  description: "API Gateway for Echo Backend Services"
  environment: ${APP_ENV:development}

server:
  host: ${SERVER_HOST:0.0.0.0}
  port: ${SERVER_PORT:8080}
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s
  shutdown_timeout: 30s
  max_header_bytes: 1048576
  enable_compression: true
  tls_enabled: ${TLS_ENABLED:false}
  tls_cert_file: ${TLS_CERT_FILE}
  tls_key_file: ${TLS_KEY_FILE}
  tls_min_version: 1.2

services:
  auth-service:
    protocol: http
    addresses:
      - ${AUTH_SERVICE_ADDR:localhost:8081}
    health_check:
      enabled: true
      path: /health
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    loadbalancer: roundrobin
    circuit_breaker:
      enabled: true
      threshold: 5
      timeout: 30s
      half_open_requests: 1
    timeout: 10s
    retry_attempts: 3

  user-service:
    protocol: http
    addresses:
      - ${USER_SERVICE_ADDR:localhost:8082}
    health_check:
      enabled: true
      path: /health
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    loadbalancer: roundrobin
    circuit_breaker:
      enabled: true
      threshold: 5
      timeout: 30s
      half_open_requests: 1
    timeout: 10s
    retry_attempts: 3

  message-service:
    protocol: grpc
    addresses:
      - ${MESSAGE_SERVICE_ADDR:message-service-service:50051}
    health_check:
      enabled: true
      path: /health
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    loadbalancer: roundrobin
    circuit_breaker:
      enabled: true
      threshold: 5
      timeout: 30s
      half_open_requests: 1
    timeout: 15s
    retry_attempts: 3

  media-service:
    protocol: http
    addresses:
      - ${MEDIA_SERVICE_ADDR:media-service-service:8080}
    health_check:
      enabled: true
      path: /health
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    loadbalancer: roundrobin
    circuit_breaker:
      enabled: true
      threshold: 5
      timeout: 30s
      half_open_requests: 1
    timeout: 30s
    retry_attempts: 2

  notification-service:
    protocol: grpc
    addresses:
      - ${NOTIFICATION_SERVICE_ADDR:notification-service:50051}
    health_check:
      enabled: true
      path: /health
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    loadbalancer: roundrobin
    circuit_breaker:
      enabled: true
      threshold: 5
      timeout: 30s
      half_open_requests: 1
    timeout: 10s
    retry_attempts: 3

  presence-service:
    protocol: grpc
    addresses:
      - ${PRESENCE_SERVICE_ADDR:presence-service:50051}
    health_check:
      enabled: true
      path: /health
      interval: 10s
      timeout: 5s
      failure_threshold: 3
    loadbalancer: roundrobin
    circuit_breaker:
      enabled: true
      threshold: 5
      timeout: 30s
      half_open_requests: 1
    timeout: 10s
    retry_attempts: 3

router_groups:
  - name: auth_routes
    prefix: /api/v1/auth
    service: auth-service
    transform: true
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS

  - name: user_routes
    prefix: /api/v1/users
    service: user-service
    transform: true
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS

  - name: message_routes
    prefix: /api/v1/messages
    service: message-service
    transform: true
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS

  - name: media_routes
    prefix: /api/v1/media
    service: media-service
    transform: true
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  - name: notification_routes
    prefix: /api/v1/notifications
    service: notification-service
    transform: true
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  - name: presence_routes
    prefix: /api/v1/presence
    service: presence-service
    transform: true
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

ratelimit:
  enabled: true
  store: memory
  redis_addr: ${REDIS_ADDR:redis:6379}
  redis_password: ${REDIS_PASSWORD}
  redis_db: ${REDIS_DB:0}
  
  global:
    requests: 10000
    window: 1m
    strategy: token_bucket
  
  endpoints:
    /api/v1/auth/login:
      requests: 5
      window: 5m
      strategy: sliding_window
    /api/v1/auth/register:
      requests: 3
      window: 1h
      strategy: fixed_window
    /api/v1/media/upload:
      requests: 10
      window: 1m
      strategy: token_bucket

security:
  allowed_origins:
    - ${CORS_ORIGIN_1:http://localhost:3000}
    - ${CORS_ORIGIN_2:http://localhost:5173}
    - ${CORS_ORIGIN_3:https://yourdomain.com}
  allowed_methods:
    - GET
    - POST
    - PUT
    - DELETE
    - PATCH
    - OPTIONS
  allowed_headers:
    - Content-Type
    - Authorization
    - X-Request-ID
    - X-Correlation-ID
    - X-API-Key
  exposed_headers:
    - X-Request-ID
    - X-Correlation-ID
    - X-RateLimit-Limit
    - X-RateLimit-Remaining
    - X-RateLimit-Reset
  allow_credentials: true
  max_age: 3600
  security_headers:
    X-Frame-Options: DENY
    X-Content-Type-Options: nosniff
    X-XSS-Protection: "1; mode=block"
    Strict-Transport-Security: "max-age=31536000; includeSubDomains"
    Content-Security-Policy: "default-src 'self'"
    Referrer-Policy: "strict-origin-when-cross-origin"
    Permissions-Policy: "geolocation=(), microphone=(), camera=()"
  max_body_size: 10485760
  path_limits:
    /api/v1/media/upload: 104857600

loadbalance:
  default_strategy: roundrobin

monitoring:
  enabled: true
  metrics_enabled: true
  metrics_path: /metrics
  health_path: /health
  tracing_enabled: false
  tracing_endpoint: ${TRACING_ENDPOINT:http://jaeger:14268/api/traces}
  tracing_sample_rate: 0.1
  log_level: ${LOG_LEVEL:info}
  log_format: json
  log_output: stdout

discovery:
  enabled: false
  provider: consul
  consul:
    address: ${CONSUL_ADDR:localhost:8500}
    scheme: http
    datacenter: ${CONSUL_DATACENTER:dc1}
    token: ${CONSUL_TOKEN}
  etcd:
    endpoints:
      - ${ETCD_ENDPOINT:localhost:2379}
    timeout: 5s
  kubernetes:
    namespace: ${K8S_NAMESPACE:default}
    label_selector: app=echo-backend
  refresh_interval: 30s

shutdown:
  timeout: 30s
  wait_for_connections: true
  drain_timeout: