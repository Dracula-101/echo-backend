# =============================================================================
# Development Dockerfile with Air for Hot Reload
# =============================================================================
FROM golang:1.25-alpine

# Install development dependencies including Air
RUN apk add --no-cache \
    git \
    ca-certificates \
    tzdata \
    curl \
    bash

# Install Air for live reloading (compatible with Go 1.23)
RUN go install github.com/air-verse/air@v1.52.3

WORKDIR /app

# Copy go.mod files for dependency caching
COPY shared/go.mod shared/go.sum ./shared/
COPY services/api-gateway/go.mod services/api-gateway/go.sum ./services/api-gateway/

# Set working directory to api-gateway
WORKDIR /app/services/api-gateway

# Replace the shared module path to use local copy
RUN go mod edit -replace shared=../../shared

# Download dependencies
RUN go mod download

# Copy Air config
COPY services/api-gateway/.air.toml .
COPY services/api-gateway/.env.docker .env

# The source code will be mounted as a volume
# This allows for live reloading when files change

# Expose application port
EXPOSE 8080

# Run Air for live reloading
CMD ["air", "-c", ".air.toml"]
